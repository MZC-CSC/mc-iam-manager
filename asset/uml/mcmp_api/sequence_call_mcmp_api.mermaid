sequenceDiagram
    participant Client
    participant Router as main.go (Echo)
    participant McmpApiAuthMiddleware as middleware.McmpApiAuthMiddleware
    participant KeycloakService as service.KeycloakService %% For RPT Validation
    participant McmpApiHandler as handler.McmpApiHandler
    participant McmpApiService as service.McmpApiService
    participant McmpApiRepo as repository.McmpApiRepository
    participant TargetMcmpApi

    Client->>+Router: POST /api/mcmp-apis/call (Body: McmpApiCallRequest, Header: Bearer RPT)
    Router->>+McmpApiAuthMiddleware: Handle Request
    McmpApiAuthMiddleware->>McmpApiAuthMiddleware: Extract RPT from Header
    McmpApiAuthMiddleware->>+KeycloakService: ValidateTokenAndGetClaims(ctx, rptToken) %% Using DecodeAccessToken internally
    KeycloakService-->>-McmpApiAuthMiddleware: Claims or Error
    alt Invalid RPT
        McmpApiAuthMiddleware-->>-Router: 401 Unauthorized
        Router-->>-Client: 401 Unauthorized
    else Valid RPT
        McmpApiAuthMiddleware->>McmpApiAuthMiddleware: Extract permissions claim from RPT
        McmpApiAuthMiddleware->>McmpApiAuthMiddleware: Bind Request Body (to get service/action) %% Potential issue: Consumes body
        McmpApiAuthMiddleware->>McmpApiAuthMiddleware: TODO: Lookup required permission ID from YAML map
        McmpApiAuthMiddleware->>McmpApiAuthMiddleware: Check if required permission exists in RPT claims
        alt Permission Denied
            McmpApiAuthMiddleware-->>-Router: 403 Forbidden
            Router-->>-Client: 403 Forbidden
        else Permission Granted
            McmpApiAuthMiddleware->>+McmpApiHandler: McmpApiCall(c) %% next(c) called
            %% Note: Handler might need to re-bind body if middleware consumed it
            McmpApiHandler->>McmpApiHandler: Bind Request Body (McmpApiCallRequest)
            McmpApiHandler->>+McmpApiService: CallAPI(ctx, req)
            McmpApiService->>+McmpApiRepo: FindServiceByName(req.ServiceName)
            McmpApiRepo-->>-McmpApiService: Service Info (BaseURL, Auth, etc.)
            McmpApiService->>+McmpApiRepo: FindActionByName(req.ServiceName, req.ActionName)
            McmpApiRepo-->>-McmpApiService: Action Info (Method, Path)
            McmpApiService->>McmpApiService: Construct Target API Request
            McmpApiService->>+TargetMcmpApi: Execute HTTP Request
            TargetMcmpApi-->>-McmpApiService: Target API Response
            McmpApiService-->>-McmpApiHandler: Target API Response or Error
            McmpApiHandler-->>-Router: Target API Response or Error
            Router-->>-Client: Target API Response or Error
        end
    end
