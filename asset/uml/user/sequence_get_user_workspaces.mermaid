sequenceDiagram
    participant Client
    participant Router as main.go (Echo)
    participant AuthMiddleware as middleware.AuthMiddleware
    participant UserHandler as handler.UserHandler
    participant UserService as service.UserService
    participant UserRepo as repository.UserRepository
    participant WorkspaceRepo as repository.WorkspaceRepository
    participant KeycloakService as service.KeycloakService %% Needed if SyncUser is called
    participant Keycloak %% Needed if SyncUser is called

    Client->>+Router: GET /api/users/workspaces (Header: Auth Token)
    Router->>+AuthMiddleware: Verify Token
    AuthMiddleware-->>-Router: Token OK (Set User Info/Claims)
    Router->>+UserHandler: GetUserWorkspaceAndWorkspaceRoles(c)
    UserHandler->>UserHandler: Get Claims from Context
    UserHandler->>UserHandler: Extract kcUserId from Claims
    UserHandler->>+UserService: GetUserIDByKcID(ctx, kcUserId)
    UserService->>+UserRepo: FindByKcID(kcUserId)
    alt DB User Not Found
        UserRepo-->>-UserService: nil
        UserService->>UserService: SyncUser(ctx, kcUserId)
        UserService->>+KeycloakService: GetUser(ctx, kcUserId)
        KeycloakService->>+Keycloak: Get User Details
        Keycloak-->>-KeycloakService: Keycloak User Info
        KeycloakService-->>-UserService: Keycloak User Info
        UserService->>+UserRepo: CreateDbUser(newUser)
        UserRepo-->>-UserService: Created DB User (with ID)
        UserService-->>-UserHandler: DB User ID (localUserID)
    else DB User Found
        UserRepo-->>-UserService: DB User (with ID)
        UserService-->>-UserHandler: DB User ID (localUserID)
    end
    UserHandler->>+UserService: GetUserWorkspaceAndWorkspaceRoles(ctx, localUserID)
    UserService->>+UserRepo: FindWorkspaceAndWorkspaceRolesByUserID(localUserID)
    UserRepo-->>-UserService: UserWorkspaceRole List (with WorkspaceRole preloaded)
    loop For Each Unique Workspace ID
        UserService->>+WorkspaceRepo: GetByID(workspaceID)
        WorkspaceRepo-->>-UserService: Workspace Info
    end
    UserService->>UserService: Merge Workspace Info and Role Info
    UserService-->>-UserHandler: []WorkspaceRoleInfo
    UserHandler-->>-Router: 200 OK ([]WorkspaceRoleInfo)
    Router-->>-Client: 200 OK ([]WorkspaceRoleInfo)
